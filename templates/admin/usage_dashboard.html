{% extends "/base.html" %}
{% set active_page = "profile" %}
{% set active_link = "admin" %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/chartist.js/latest/chartist.min.css">
<script src="https://cdn.jsdelivr.net/chartist.js/latest/chartist.min.js"></script>
<style>
    .ct-bar {
        stroke: #aae266 !important;
    }
    .ct-line, .ct-point {
        stroke: #3AB0D5 !important;
    }
</style>
<div class="container">
    <div class="col-md-12" style="margin-top:30px;">
        <h1><strong>{{ _('Usage Dashboard') }}</strong></h1>

        <label for="timeframe-select">Timeframe:</label>
        <select name="timeframe-select" id="timeframe-select" onchange="redirect()">
            <option disabled value> Select a timeframe </option>
            <option value="30">1 Month</option>
            <option value="90">3 Months</option>
            <option value="183">6 Months</option>
            <option value="365">1 Year</option>
            <option value="all">All Time</option>
        </select>
    </div>
</div>
<div class="container">
    <div class="col-md-12">
        <h2 id ="large-header">{{ _('Platform Totals — ')}}</h2>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th></th>
                        <th><p id = table-header><strong></strong></p></th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat, value in stats.items() %}
                    <tr>
                        <th><p><strong>{{ stat | replace('_', ' ') }}</strong></p></th>
                        <td>
                            <p>
                                {% if value[0][1] != None %}
                                    <a href="#" class="stat-link" data-toggle="modal" data-target="#statsModal" data-ids="{{ value[0][1] }}" data-names="{{ value[0][2] }}">{{ value[0][0] }}</a>
                                {% else %}
                                    {{ value[0][0] }}
                                {% endif %}
                            </p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- Modal -->
            <div class="modal fade" id="statsModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="myModalLabel">Stat Details</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">×</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <p id="project-ids"></p>
                            <p id="project-names"></p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End of Modal -->
    </div>
</div>
<script>

function getFormatedStringFromDays(_days) {
    let text_map = { '30': 'Last Month', '90': 'Last 3 Months', '183': 'Last 6 Months', '365': 'Last Year', 'all': 'All Time' }
    if (_days in text_map) return text_map[_days]

    // calculate estimated date
    let numDays = parseInt(_days)
    let years = Math.floor(numDays / 365);
    let months = Math.floor(numDays % 365 / 30.416667);
    let days = Math.floor(numDays % 365 % 30.416667);

    let res = []
    if (years > 0) res.push(years + " Year" + (years > 1 ? "s" : ""))
    if (months > 0) res.push(months + " Month" + (months > 1 ? "s" : ""))
    if (days > 0) res.push(days + " Day" + (days > 1 ? "s" : ""))
    return 'Last ' + res.join(', ');
}
let timeframe_select = document.getElementById('timeframe-select')

$(document).ready(function() {
    // set select input value
    const urlParams = new URLSearchParams(window.location.search);
    const days = urlParams.get('days').toString()
    timeframe_select.value = { '30': '30', '90': '90', '183': '183', '365': '365', 'all': 'all' }[days] || null;

    // set headers
    let date_text = getFormatedStringFromDays(days)
    document.getElementById('table-header').textContent = date_text;
    document.getElementById('large-header').textContent += date_text;

    // Initialize count stats.
    $('.stat-link').on('click', function(){
        var ids = `${$(this).data('ids')}`.split(',');
        var names = `${$(this).data('names')}`.split(',');
        var idsHtml = 'Project IDs: ';
        var namesHtml = 'Project Names: ';
        for (var i = 0; i < ids.length; i++) {
            idsHtml += '<a href="/projectid/' + ids[i].trim() + '">' + ids[i] + '</a>, ';
            namesHtml += '<a href="/projectid/' + ids[i].trim() + '">' + names[i] + '</a>, ';
        }
        $('#project-ids').html(idsHtml.slice(0, -2));
        $('#project-names').html(namesHtml.slice(0, -2));
    });
})

function redirect() {
    let url = window.location.origin + '/admin/usage_dashboard/?days=' + timeframe_select.value
    window.location.replace(url)
}
</script>
{% endblock %}
